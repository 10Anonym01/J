<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>JARVIS</title>
</head>
<body>
  <h1>JARVIS</h1>
  <button onclick="startListening()">Говори</button>
  <button onclick="stopListening()">Стоп</button>
  <p id="userText">Ты: ...</p>
  <p id="response">JARVIS: ...</p>

  <script>
    const userText = document.getElementById("userText");
    const responseText = document.getElementById("response");
    let recognition = null;

    function startListening() {
      if (!recognition) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = "ru-RU";

        recognition.onresult = function(event) {
          const text = event.results[0][0].transcript;
          userText.innerText = "Ты: " + text;
          sendToJarvis(text);
        };

        recognition.onend = function() {
          recognition = null;
        };

        recognition.start();
      }
    }

    function stopListening() {
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
    }

    function sendToJarvis(text) {
      fetch("https://jb-y4dw.onrender.com/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: text })
      })
      .then(res => res.json())
      .then(data => {
        responseText.innerText = "JARVIS: " + data.answer;
        console.log("Ответ:", data.answer);
        console.log("Аудио URL:", data.audio);
        speak(data.audio);
      })
      .catch(err => {
        responseText.innerText = "JARVIS: ошибка ответа";
        console.error("Ошибка:", err);
      });
    }

    function speak(audioUrl) {
      if (audioUrl) {
        const audio = new Audio(audioUrl);
        audio.play().catch(e => console.error("Ошибка при воспроизведении:", e));
      } else {
        console.warn("Нет ссылки на аудио, воспроизведение не начато");
      }
    }
  </script>
</body>
</html>
