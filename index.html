<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>JARVIS</title>
</head>
<body>
  <h1>JARVIS</h1>
  <button onclick="startListening()">Говори</button>
  <button onclick="stopListening()">Стоп</button>
  <p id="userText">  >... </p>
  <p id="response">JARVIS: ...</p>

  <script>
    const userText = document.getElementById("userText");
    const responseText = document.getElementById("response");
    let recognition;

    function startListening() {
      if (!recognition) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = "ru-RU";

        recognition.onresult = function(event) {
          const text = event.results[0][0].transcript;
          userText.innerText = "  > " + text;
          sendToJarvis(text);
        };

        recognition.onend = function() {
          recognition = null;
        };

        recognition.start();
      }
    }

    function stopListening() {
      if (recognition) {
        recognition.stop();
        recognition = null;
        console.log("Микрофон отключён");
      }
    }

    function sendToJarvis(text) {
      fetch("https://jb-y4dw.onrender.com/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: text })
      })
      .then(res => res.json())
      .then(data => {
        responseText.innerText = "JARVIS: " + data.answer;
        speak(data.answer);
      })
      .catch(err => {
        responseText.innerText = "JARVIS: ошибка ответа";
        console.error("Ошибка:", err);
      });
    }

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = /[а-яА-ЯЁё]/.test(text) ? "ru-RU" : "en-US";
      speechSynthesis.cancel(); // отключаем старый голос
      speechSynthesis.speak(msg);
    }

    // Safari: активируем речь
    document.addEventListener("click", () => {
      if (!window._speechTested) {
        speechSynthesis.speak(new SpeechSynthesisUtterance(" "));
        window._speechTested = true;
      }
    });
  </script>
</body>
</html>
